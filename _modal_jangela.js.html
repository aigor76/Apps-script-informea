<script>
    let alumnoActual = null;

    function inicializar() {
        console.log('ðŸš€ Inicializando Jangela...');
        configurarEventos();
        cargarAlumnoActivo();
    }

    function cargarAlumnoActivo() {
        // Obtener alumno activo
        google.script.run
            .withSuccessHandler(function(nombreAlumno) {
                if (nombreAlumno) {
                    alumnoActual = nombreAlumno;
                    document.getElementById('nombreAlumnoActivo').textContent = `ðŸ‘¤ ${nombreAlumno}`;
                    cargarDatosEvaluaciones();
                } else {
                    document.getElementById('nombreAlumnoActivo').textContent = 'âŒ No hay alumno seleccionado';
                    mostrarEstado(1, 'error', 'No hay alumno seleccionado');
                }
            })
            .withFailureHandler(function(error) {
                console.error('Error obteniendo alumno activo:', error);
                document.getElementById('nombreAlumnoActivo').textContent = 'âŒ Error al cargar alumno';
            })
            .obtenerAlumnoActivo();
    }

    function configurarEventos() {
        const selects1 = ['jatea1', 'jarrera1', 'autonomia1'];
        const selects2 = ['jatea2', 'jarrera2', 'autonomia2'];

        selects1.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.addEventListener('change', () => validarFormulario(1));
            }
        });

        selects2.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.addEventListener('change', () => validarFormulario(2));
            }
        });
    }

    function cambiarPestana(pestana) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        document.getElementById(pestana).classList.add('active');

        const tabs = document.querySelectorAll('.tab');
        if (pestana === 'evaluacion1' && tabs[0]) {
            tabs[0].classList.add('active');
        } else if (pestana === 'evaluacion2' && tabs[1]) {
            tabs[1].classList.add('active');
            cargarReferenciaPrimera();
        }
    }

    function cargarDatosEvaluaciones() {
        // Cargar datos de evaluaciÃ³n 1
        google.script.run
            .withSuccessHandler(function(datos) {
                if (datos.tieneDatos) {
                    document.getElementById('jatea1').value = datos.jatea || '';
                    document.getElementById('jarrera1').value = datos.jarrera || '';
                    document.getElementById('autonomia1').value = datos.autonomia || '';
                    validarFormulario(1);

                    // Si hay datos en 1Âª evaluaciÃ³n, cambiar a 2Âª pestaÃ±a
                    if (datos.jatea || datos.jarrera || datos.autonomia) {
                        cambiarPestana('evaluacion2');
                    }
                }
            })
            .withFailureHandler(function(error) {
                console.log('Error cargando datos evaluaciÃ³n 1:', error);
            })
            .obtenerDatosJangela(1);

        // Cargar datos de evaluaciÃ³n 2
        google.script.run
            .withSuccessHandler(function(datos) {
                if (datos.tieneDatos) {
                    document.getElementById('jatea2').value = datos.jatea || '';
                    document.getElementById('jarrera2').value = datos.jarrera || '';
                    document.getElementById('autonomia2').value = datos.autonomia || '';
                    validarFormulario(2);
                }
            })
            .withFailureHandler(function(error) {
                console.log('Error cargando datos evaluaciÃ³n 2:', error);
            })
            .obtenerDatosJangela(2);
    }

    function cargarReferenciaPrimera() {
        google.script.run
            .withSuccessHandler(function(datos) {
                const referenciaDiv = document.getElementById('referenciaPrimera');
                const datosDiv = document.getElementById('datosReferencia');

                if (datos.tieneDatos) {
                    let mensaje = '';
                    if (datos.jatea) mensaje += `ðŸ½ï¸ JATEA: ${datos.jatea} `;
                    if (datos.jarrera) mensaje += `ðŸ˜Š JARRERA: ${datos.jarrera} `;
                    if (datos.autonomia) mensaje += `ðŸŽ¯ AUTONOMIA: ${datos.autonomia}`;

                    datosDiv.textContent = mensaje || 'Ez dago daturik';
                    referenciaDiv.style.display = 'block';
                } else {
                    datosDiv.textContent = 'Lehenengo ebaluaketako daturik gabe';
                    referenciaDiv.style.display = 'block';
                }
            })
            .withFailureHandler(function(error) {
                console.log('Error cargando referencia:', error);
            })
            .obtenerDatosJangela(1);
    }

    function validarFormulario(evaluacion) {
        const jatea = document.getElementById(`jatea${evaluacion}`).value;
        const jarrera = document.getElementById(`jarrera${evaluacion}`).value;
        const autonomia = document.getElementById(`autonomia${evaluacion}`).value;

        const guardarBtn = document.getElementById(`guardarBtn${evaluacion}`);
        const algunoSeleccionado = jatea || jarrera || autonomia;
        guardarBtn.disabled = !algunoSeleccionado;

        return algunoSeleccionado;
    }

    function guardarEvaluacion(evaluacion) {
        if (!validarFormulario(evaluacion)) {
            mostrarEstado(evaluacion, 'error', 'âš ï¸ Aukeratu gutxienez irizpide bat');
            return;
        }

        const jatea = document.getElementById(`jatea${evaluacion}`).value;
        const jarrera = document.getElementById(`jarrera${evaluacion}`).value;
        const autonomia = document.getElementById(`autonomia${evaluacion}`).value;

        const evaluacionData = {
            jatea: jatea,
            jarrera: jarrera,
            autonomia: autonomia
        };

        const guardarBtn = document.getElementById(`guardarBtn${evaluacion}`);
        guardarBtn.disabled = true;
        guardarBtn.textContent = 'â³ Txertatzen...';

        google.script.run
            .withSuccessHandler(function(resultado) {
                if (resultado.success) {
                    mostrarEstado(evaluacion, 'success', resultado.message);

                    if (evaluacion === 1) {
                        setTimeout(() => {
                            cargarReferenciaPrimera();
                        }, 500);
                    }

                    // VOLVER AL SELECTOR despuÃ©s de 2 segundos
                    setTimeout(() => {
                        volverASelector();
                    }, 2000);

                } else {
                    mostrarEstado(evaluacion, 'error', resultado.message);
                    guardarBtn.disabled = false;
                    guardarBtn.textContent = `âœ… ${evaluacion}Âª Ebal Txertatu`;
                }
            })
            .withFailureHandler(function(error) {
                mostrarEstado(evaluacion, 'error', 'Error: ' + error.message);
                guardarBtn.disabled = false;
                guardarBtn.textContent = `âœ… ${evaluacion}Âª Ebal Txertatu`;
            })
            .insertarEvaluacionJangela(evaluacionData, evaluacion);
    }

    function volverASelector() {
        // Cerrar este modal y abrir el selector
        google.script.run
            .withSuccessHandler(function() {
                google.script.host.close();
            })
            .abrirSelectorAlumnos();
    }

    function mostrarEstado(evaluacion, tipo, mensaje) {
        const status = document.getElementById(`status${evaluacion}`);
        if (!status) return;

        status.className = `status ${tipo}`;
        status.textContent = mensaje;
        status.style.display = 'block';

        setTimeout(() => {
            if (status) {
                status.style.display = 'none';
            }
        }, 4000);
    }

    window.onload = inicializar;
</script>
