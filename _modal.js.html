<script>
    let configuraciones = [];
    let configuracionActual = null;
    let criteriosData = [];
    let criteriosSeleccionados1 = [];
    let criteriosSeleccionados2 = [];

    function inicializar() {
        try {
            const configuracionString = '<?= configuracion ?>';

            if (configuracionString && configuracionString !== 'undefined' && configuracionString !== '') {
                configuraciones = JSON.parse(configuracionString);
                llenarSelectorAmbitos();
            } else {
                mostrarEstado(1, 'error', 'No se encontr√≥ configuraci√≥n de √°mbitos en la Hoja 1');
            }

        } catch (error) {
            console.error('Error durante la inicializaci√≥n:', error);
            mostrarEstado(1, 'error', 'Error al cargar configuraci√≥n: ' + error.message);
        }
    }

    function llenarSelectorAmbitos() {
        const selector = document.getElementById('selectorAmbito');
        selector.innerHTML = '<option value="">-- Aukeratu esparru bat --</option>';

        configuraciones.forEach((config, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = config.nombreHoja;
            selector.appendChild(option);
        });

        selector.addEventListener('change', function() {
            setTimeout(() => cambiarAmbito(), 10);
        });

        // Inicializar botones de navegaci√≥n
        actualizarBotonesNavegacion();
    }

    function cambiarAmbito() {
        const selector = document.getElementById('selectorAmbito');
        if (!selector) {
            console.error('Selector de √°mbito no encontrado');
            return;
        }

        const selectedIndex = selector.value;

        if (selectedIndex === '' || selectedIndex === null || selectedIndex === undefined) {
            configuracionActual = null;
            criteriosData = [];
            limpiarDatos();
            actualizarInterfaz();
            actualizarBotonesNavegacion();
            return;
        }

        const configIndex = parseInt(selectedIndex);

        if (isNaN(configIndex) || configIndex < 0 || configIndex >= configuraciones.length) {
            console.error('√çndice inv√°lido:', configIndex, 'Longitud array:', configuraciones.length);
            mostrarEstado(1, 'error', 'Error: √çndice de configuraci√≥n inv√°lido');
            return;
        }

        configuracionActual = configuraciones[configIndex];

        if (!configuracionActual) {
            console.error('Configuraci√≥n es null/undefined');
            mostrarEstado(1, 'error', 'Error: Configuraci√≥n no encontrada');
            return;
        }

        try {
            const headerSubtitle = document.getElementById('headerSubtitle');
            const maxCriterios1 = document.getElementById('maxCriterios1');
            const maxCriterios2 = document.getElementById('maxCriterios2');

            if (headerSubtitle) {
                headerSubtitle.textContent = ` ${configuracionActual.nombreHoja}-ren ebaluazioa`;
            }
            if (maxCriterios1) {
                maxCriterios1.textContent = configuracionActual.numeroCriterios;
            }
            if (maxCriterios2) {
                maxCriterios2.textContent = configuracionActual.numeroCriterios;
            }

            actualizarFooterInfo();
            limpiarDatos();
            cargarCriteriosAmbito();
            actualizarBotonesNavegacion();

        } catch (error) {
            console.error('Error al actualizar interfaz:', error);
            mostrarEstado(1, 'error', 'Error al actualizar interfaz: ' + error.message);
        }
    }

    function actualizarBotonesNavegacion() {
        const selector = document.getElementById('selectorAmbito');
        const btnAnterior = document.getElementById('btnAnterior');
        const btnSiguiente = document.getElementById('btnSiguiente');

        if (!selector || !btnAnterior || !btnSiguiente) return;

        const currentIndex = parseInt(selector.value);
        const maxIndex = configuraciones.length - 1;

        // Bot√≥n Anterior
        if (isNaN(currentIndex) || currentIndex <= 0) {
            btnAnterior.disabled = true;
            btnAnterior.style.color = '#9aa0a6';
            btnAnterior.style.cursor = 'not-allowed';
        } else {
            btnAnterior.disabled = false;
            btnAnterior.style.color = '#1a73e8';
            btnAnterior.style.cursor = 'pointer';
        }

        // Bot√≥n Siguiente
        if (isNaN(currentIndex) || currentIndex >= maxIndex) {
            btnSiguiente.disabled = true;
            btnSiguiente.style.color = '#9aa0a6';
            btnSiguiente.style.cursor = 'not-allowed';
        } else {
            btnSiguiente.disabled = false;
            btnSiguiente.style.color = '#1a73e8';
            btnSiguiente.style.cursor = 'pointer';
        }
    }

    function cambiarAmbitoAnterior() {
        const selector = document.getElementById('selectorAmbito');
        const currentIndex = parseInt(selector.value);

        if (!isNaN(currentIndex) && currentIndex > 0) {
            selector.value = (currentIndex - 1).toString();
            cambiarAmbito();
        }
    }

    function cambiarAmbitoSiguiente() {
        const selector = document.getElementById('selectorAmbito');
        const currentIndex = parseInt(selector.value);
        const maxIndex = configuraciones.length - 1;

        if (!isNaN(currentIndex) && currentIndex < maxIndex) {
            selector.value = (currentIndex + 1).toString();
            cambiarAmbito();
        }
    }

    function actualizarFooterInfo() {
        if (!configuracionActual) return;

        const footerInfo1 = document.getElementById('footerInfo1');
        const footerInfo2 = document.getElementById('footerInfo2');

        if (!footerInfo1 || !footerInfo2) {
            console.error('Elementos footerInfo no encontrados');
            return;
        }

        footerInfo1.innerHTML = `
            <strong> 1¬™ Eval (${configuracionActual.nombreHoja}):</strong><br>
            ‚Ä¢ Itemak: ${configuracionActual.celdasOcupa}<br>
            ‚Ä¢ Kalifikazioa: ${configuracionActual.celda1Eval}<br>
            ‚Ä¢ Gehienezko itemak: ${configuracionActual.numeroCriterios}
        `;

        footerInfo2.innerHTML = `
            <strong> 2¬™ Eval (${configuracionActual.nombreHoja}):</strong><br>
            ‚Ä¢ Itemak: ${configuracionActual.celdasOcupa} (sobrescribe 1¬™)<br>
            ‚Ä¢ Kalifikazioa: ${configuracionActual.celda2Eval}<br>
            ‚Ä¢ Gehienezko itemak: ${configuracionActual.numeroCriterios}
        `;
    }

    function cargarCriteriosAmbito() {
        if (!configuracionActual) return;

        const loadingIndicator = document.getElementById('ambitoLoading');
        const loading1 = document.getElementById('loading1');
        const loading2 = document.getElementById('loading2');

        if (loadingIndicator) {
            loadingIndicator.classList.add('show');
        }

        if (loading1) {
            loading1.textContent = `üîÑ Itemak kargatzen ${configuracionActual.nombreHoja}...`;
            loading1.style.display = 'block';
        }

        if (loading2) {
            loading2.textContent = `üîÑ Itemak kargatzen ${configuracionActual.nombreHoja}...`;
            loading2.style.display = 'block';
        }

        google.script.run
            .withSuccessHandler(function(criterios) {
                if (loadingIndicator) {
                    loadingIndicator.classList.remove('show');
                }
                if (loading1) {
                    loading1.style.display = 'none';
                }
                if (loading2) {
                    loading2.style.display = 'none';
                }

                if (!criterios || criterios.length === 0) {
                    mostrarEstado(1, 'error', `No se encontraron criterios en la hoja "${configuracionActual.nombreHoja}"`);
                    mostrarEstado(2, 'error', `No se encontraron criterios en la hoja "${configuracionActual.nombreHoja}"`);
                } else {
                    criteriosData = criterios;
                    renderizarCriterios(1);
                    renderizarCriterios(2);
                    cargarDatosPrimeraEvaluacion();

                    // NUEVA FUNCIONALIDAD: Verificar si hay datos de 1¬™ evaluaci√≥n para saltar a 2¬™ pesta√±a
                    verificarYSaltarPestana();
                }
            })
            .withFailureHandler(function(error) {
                if (loadingIndicator) {
                    loadingIndicator.classList.remove('show');
                }
                if (loading1) {
                    loading1.style.display = 'none';
                }
                if (loading2) {
                    loading2.style.display = 'none';
                }

                const mensajeError = error.message || error.toString();
                mostrarEstado(1, 'error', `Errore kargatzen "${configuracionActual.nombreHoja}": ${mensajeError}`);
                mostrarEstado(2, 'error', `Errorea kargatzen "${configuracionActual.nombreHoja}": ${mensajeError}`);
            })
            .cargarTodosLosCriterios(configuracionActual.nombreHoja, configuracionActual.numeroCriterios);
    }

    function verificarYSaltarPestana() {
        if (!configuracionActual) return;

        // Verificar si hay datos de 1¬™ evaluaci√≥n
        google.script.run
            .withSuccessHandler(function(datos) {
                // Si hay nota en 1¬™ evaluaci√≥n, saltar autom√°ticamente a 2¬™ pesta√±a
                if (datos && datos.tieneDatos && datos.nota && datos.nota.trim() !== '') {
                    console.log('üéØ 1¬™ evaluaci√≥n completada detectada, saltando a 2¬™ pesta√±a');
                    cambiarPestana('evaluacion2');
                } else {
                    console.log('‚ÑπÔ∏è No hay datos de 1¬™ evaluaci√≥n, permaneciendo en 1¬™ pesta√±a');
                    // Asegurar que est√© en 1¬™ pesta√±a si no hay datos
                    const pestana1Activa = document.getElementById('evaluacion1').classList.contains('active');
                    if (!pestana1Activa) {
                        cambiarPestana('evaluacion1');
                    }
                }
            })
            .withFailureHandler(function(error) {
                console.log('‚ÑπÔ∏è Error verificando 1¬™ evaluaci√≥n, permaneciendo en pesta√±a actual:', error);
                // En caso de error, no hacer nada (mantener pesta√±a actual)
            })
            .obtenerDatosPrimera(configuracionActual);
    }

    function limpiarDatos() {
        criteriosSeleccionados1 = [];
        criteriosSeleccionados2 = [];

        document.getElementById('notaEvaluacion1').value = '';
        document.getElementById('notaEvaluacion2').value = '';

        actualizarContador(1);
        actualizarContador(2);
        actualizarPreview(1);
        actualizarPreview(2);
    }

    function actualizarInterfaz() {
        if (!configuracionActual) {
            document.getElementById('loading1').textContent = 'üîÑ Aukeratu esparru bat itemak kargatzeko...';
            document.getElementById('loading2').textContent = 'üîÑ Aukeratu esparru bat itemak kargatzeko...';
            document.getElementById('referenciaPrimera').textContent = 'Aukeratu esparru bat itemak kargatzeko...';
            document.getElementById('footerInfo1').innerHTML = '<strong>Aukeratu esparru bat konfigurazioa ikusteko</strong>';
            document.getElementById('footerInfo2').innerHTML = '<strong>Aukeratu esparru bat konfigurazioa ikusteko</strong>';
            document.getElementById('headerSubtitle').textContent = 'Aldi akademikoen ebaluazio sistema';
        }
    }

    function cambiarPestana(pestana) {
        // Limpiar clases activas
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Activar nueva pesta√±a
        document.getElementById(pestana).classList.add('active');

        // Encontrar y activar el bot√≥n correspondiente
        const tabs = document.querySelectorAll('.tab');
        if (pestana === 'evaluacion1' && tabs[0]) {
            tabs[0].classList.add('active');
        } else if (pestana === 'evaluacion2' && tabs[1]) {
            tabs[1].classList.add('active');
        }

        // Cargar datos de primera evaluaci√≥n si se cambia a segunda pesta√±a
        if (pestana === 'evaluacion2' && configuracionActual) {
            cargarDatosPrimeraEvaluacion();
        }
    }

    function cargarDatosPrimeraEvaluacion() {
        if (!configuracionActual) {
            document.getElementById('referenciaPrimera').textContent = 'Aukeratu esparrua...';
            return;
        }

        const referenciaDiv = document.getElementById('referenciaPrimera');
        if (referenciaDiv) {
            referenciaDiv.innerHTML = 'üîÑ Datuak kargtzen...';
        } else {
            return;
        }

        google.script.run
            .withSuccessHandler(function(datos) {
                const referenciaDiv = document.getElementById('referenciaPrimera');

                if (!referenciaDiv) {
                    return;
                }

                setTimeout(() => {
                    try {
                        let mensaje = '';

                        if (datos && typeof datos === 'object') {
                            if (datos.tieneDatos) {
                                // MOSTRAR NOTA (sin HTML tags)
                                if (datos.nota && datos.nota.trim() !== '') {
                                    mensaje += `üìù Kalifikazioa: ${datos.nota}`;
                                }

                                // MOSTRAR TODOS LOS CRITERIOS HORIZONTALMENTE (sin HTML tags)
                                if (datos.criterios && Array.isArray(datos.criterios) && datos.criterios.length > 0) {
                                    if (mensaje) mensaje += ' | ';
                                    mensaje += `üìã Itemak (${datos.criterios.length}): `;

                                    // Mostrar criterios separados por " ‚Ä¢ " horizontalmente
                                    mensaje += datos.criterios.join(' ‚Ä¢ ');
                                }

                                if (mensaje) {
                                    referenciaDiv.textContent = mensaje;
                                } else {
                                    referenciaDiv.textContent = 'üìù Datuak aurkitu dira baina hutsik daude';
                                }
                            } else {
                                referenciaDiv.textContent = 'üìù Lehenengo ebaluaketako daturik gabe';
                            }
                        } else {
                            referenciaDiv.textContent = '‚ùå Datos inv√°lidos recibidos';
                        }

                    } catch (error) {
                        console.error('‚ùå Error procesando datos:', error);
                        referenciaDiv.textContent = '‚ùå Error procesando datos';
                    }
                }, 500);
            })
            .withFailureHandler(function(error) {
                const referenciaDiv = document.getElementById('referenciaPrimera');
                if (referenciaDiv) {
                    referenciaDiv.innerHTML = '‚ùå Error al cargar referencia: ' + error.message;
                }
            })
            .obtenerDatosPrimera(configuracionActual);
    }

    function renderizarCriterios(evaluacion) {
        const container = document.getElementById(`criteriaContainer${evaluacion}`);
        if (!container) {
            console.error(`Container criteriaContainer${evaluacion} no encontrado`);
            return;
        }

        const loading = document.getElementById(`loading${evaluacion}`);

        if (loading) {
            loading.style.display = 'none';
        }

        if (!criteriosData || criteriosData.length === 0) {
            const nombreHoja = configuracionActual ? configuracionActual.nombreHoja : 'seleccionada';
            container.innerHTML = `
                <div class="empty-state">
                    <strong>No se encontraron criterios en la hoja "${nombreHoja}"</strong><br><br>
                    <small>Verifica que:</small><br>
                    <small>‚Ä¢ La hoja "${nombreHoja}" existe</small><br>
                    <small>‚Ä¢ Tiene datos en las columnas A, B, C desde la fila 2</small><br>
                    <small>‚Ä¢ La columna A contiene criterios en euskera</small>
                </div>
                <div class="loading" id="loading${evaluacion}" style="display: none;">
                    üîÑ Selecciona un √°mbito para cargar criterios...
                </div>
            `;
            return;
        }

        let htmlContent = '';

        criteriosData.forEach((criterio, index) => {
            const criteriosActuales = evaluacion === 1 ? criteriosSeleccionados1 : criteriosSeleccionados2;
            const isSelected = criteriosActuales.some(sc => sc.id === criterio.id);
            const grupoIndex = Math.floor(index / 3);
            const grupoClass = grupoIndex % 2 === 0 ? 'grupo-a' : 'grupo-b';

            htmlContent += `
                <div class="criteria-item nivel-${criterio.nivel} ${grupoClass} ${isSelected ? 'selected' : ''}"
                     data-criterio-id="${criterio.id}"
                     data-evaluacion="${evaluacion}">
                    <div class="checkbox"></div>
                    <div class="criteria-content">
                        <div class="criteria-text">${criterio.texto}</div>
                    </div>
                </div>
            `;
        });

        htmlContent += `<div class="loading" id="loading${evaluacion}" style="display: none;">
            üîÑ Selecciona un √°mbito para cargar criterios...
        </div>`;

        container.innerHTML = htmlContent;

        const criteriaItems = container.querySelectorAll('.criteria-item');
        criteriaItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const criterioId = this.getAttribute('data-criterio-id');
                const criterio = criteriosData.find(c => c.id === criterioId);
                if (criterio) {
                    toggleCriterio(criterio, evaluacion);
                }
            });
        });
    }

    function toggleCriterio(criterio, evaluacion) {
        if (!configuracionActual) {
            mostrarEstado(evaluacion, 'errorea', 'Aukeratu esparua lehenengo');
            return;
        }

        let criteriosActuales = evaluacion === 1 ? criteriosSeleccionados1 : criteriosSeleccionados2;
        const isSelected = criteriosActuales.some(sc => sc.id === criterio.id);
        const MAX_SELECCION = configuracionActual.numeroCriterios;

        if (isSelected) {
            if (evaluacion === 1) {
                criteriosSeleccionados1 = criteriosSeleccionados1.filter(sc => sc.id !== criterio.id);
            } else {
                criteriosSeleccionados2 = criteriosSeleccionados2.filter(sc => sc.id !== criterio.id);
            }
        } else {
            if (criteriosActuales.length < MAX_SELECCION) {
                if (evaluacion === 1) {
                    criteriosSeleccionados1.push(criterio);
                } else {
                    criteriosSeleccionados2.push(criterio);
                }
            } else {
                const warning = document.getElementById(`limitWarning${evaluacion}`);
                warning.textContent = `‚ö†Ô∏è Gehiengoa pasatu duzu (${MAX_SELECCION}). Kendu aukera bat lehenengo`;
                warning.classList.add('show');
                setTimeout(() => {
                    warning.classList.remove('show');
                }, 2000);
                return;
            }
        }

        actualizarContador(evaluacion);
        actualizarVisualizacion(evaluacion);
        actualizarPreview(evaluacion);
    }

    function actualizarVisualizacion(evaluacion) {
        const items = document.querySelectorAll(`[data-evaluacion="${evaluacion}"].criteria-item`);
        const criteriosActuales = evaluacion === 1 ? criteriosSeleccionados1 : criteriosSeleccionados2;

        items.forEach(item => {
            const criterioId = item.getAttribute('data-criterio-id');
            const isSelected = criteriosActuales.some(sc => sc.id === criterioId);

            if (isSelected) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }

    function actualizarContador(evaluacion) {
        const criteriosActuales = evaluacion === 1 ? criteriosSeleccionados1 : criteriosSeleccionados2;
        document.getElementById(`selectedCount${evaluacion}`).textContent = criteriosActuales.length;
        document.getElementById(`insertBtn${evaluacion}`).disabled = criteriosActuales.length === 0;
    }

    function actualizarPreview(evaluacion) {
        const container = document.getElementById(`selectedItems${evaluacion}`);
        const criteriosActuales = evaluacion === 1 ? criteriosSeleccionados1 : criteriosSeleccionados2;
        container.innerHTML = '';

        if (criteriosActuales.length === 0) {
            container.innerHTML = '<span style="color: #5f6368; font-style: italic; font-size: 0.65em;">Ez duzu itemik aukeratu</span>';
            return;
        }

        criteriosActuales.forEach(criterio => {
            const item = document.createElement('div');
            item.className = 'selected-item';

            const textoCorto = criterio.texto.length > 25
                ? criterio.texto.substring(0, 25) + '...'
                : criterio.texto;

            item.innerHTML = `
                <span>${textoCorto}</span>
                <span class="remove-btn" onclick="removerCriterio('${criterio.id}', ${evaluacion}); event.stopPropagation();">&times;</span>
            `;
            container.appendChild(item);
        });
    }

    function removerCriterio(criterioId, evaluacion) {
        if (evaluacion === 1) {
            criteriosSeleccionados1 = criteriosSeleccionados1.filter(sc => sc.id !== criterioId);
        } else {
            criteriosSeleccionados2 = criteriosSeleccionados2.filter(sc => sc.id !== criterioId);
        }

        actualizarContador(evaluacion);
        actualizarVisualizacion(evaluacion);
        actualizarPreview(evaluacion);
    }

    function insertarCriterios(evaluacion) {
        if (!configuracionActual) {
            mostrarEstado(evaluacion, 'error', 'Aukeratu lehenengo esparru bat');
            return;
        }

        const criteriosActuales = evaluacion === 1 ? criteriosSeleccionados1 : criteriosSeleccionados2;
        const notaSelector = evaluacion === 1 ? 'notaEvaluacion1' : 'notaEvaluacion2';

        if (criteriosActuales.length === 0) {
            mostrarEstado(evaluacion, 'error', 'Aukeratu gutxienez esparru bat');
            return;
        }

        const notaEvaluacion = document.getElementById(notaSelector).value;
        if (!notaEvaluacion || notaEvaluacion.trim() === '') {
            const mensajeError = evaluacion === 1
                ? '‚ö†Ô∏è DERRIGORREZKOA: Gutxienez kalifikazio bat aukeratu behar duzu lehen ebaluaketarako'
                : '‚ö†Ô∏è DERRIGORREZKOA: Gutxienez kalifikazio bat aukeratu behar duzu bigarren ebaluaketarako';

            mostrarEstado(evaluacion, 'error', mensajeError);

            const selector = document.getElementById(notaSelector);
            selector.style.borderColor = '#ea4335';
            selector.style.boxShadow = '0 0 0 3px rgba(234, 67, 53, 0.3)';

            setTimeout(() => {
                selector.style.borderColor = '#ff6d01';
                selector.style.boxShadow = 'none';
            }, 3000);

            return;
        }

        const insertBtn = document.getElementById(`insertBtn${evaluacion}`);
        insertBtn.disabled = true;
        insertBtn.textContent = '‚è≥ Txertatzen...';

        google.script.run
            .withSuccessHandler((result) => onInsertSuccess(result, evaluacion))
            .withFailureHandler((error) => onInsertError(error, evaluacion))
            .insertarCriterios(criteriosActuales, notaEvaluacion, evaluacion, configuracionActual);
    }

    function onInsertSuccess(result, evaluacion) {
        if (result.success) {
            mostrarEstado(evaluacion, 'success', result.message);

            // Actualizar la referencia en la segunda pesta√±a
            if (evaluacion === 1 || evaluacion === 2) {
                cargarDatosPrimeraEvaluacion();
            }

            // Reactivar el bot√≥n para permitir m√°s inserciones si es necesario
            const insertBtn = document.getElementById(`insertBtn${evaluacion}`);
            insertBtn.disabled = false;
            insertBtn.textContent = `‚úÖ Txertatu ${evaluacion}¬™ Eval`;

            // NO CERRAR AUTOM√ÅTICAMENTE - El usuario decide cu√°ndo cerrar
        } else {
            mostrarEstado(evaluacion, 'error', result.message);
            document.getElementById(`insertBtn${evaluacion}`).disabled = false;
            document.getElementById(`insertBtn${evaluacion}`).textContent = `‚úÖ Insertar ${evaluacion}¬™ Eval`;
        }
    }

    function onInsertError(error, evaluacion) {
        console.error(`Error evaluaci√≥n ${evaluacion}:`, error);
        mostrarEstado(evaluacion, 'error', 'Error: ' + error.message);

        document.getElementById(`insertBtn${evaluacion}`).disabled = false;
        document.getElementById(`insertBtn${evaluacion}`).textContent = `‚úÖ Txertatu ${evaluacion}¬™ Eval`;
    }

    function mostrarEstado(evaluacion, tipo, mensaje) {
        const status = document.getElementById(`status${evaluacion}`);
        if (!status) {
            console.error(`Elemento status${evaluacion} no encontrado`);
            return;
        }

        status.className = `status ${tipo}`;
        status.textContent = mensaje;
        status.style.display = 'block';

        setTimeout(() => {
            if (status) {
                status.style.display = 'none';
            }
        }, 4000);
    }

    function cerrarModal() {
        google.script.host.close();
    }

    window.onload = inicializar;
</script>
